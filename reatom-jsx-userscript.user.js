// ==UserScript==
// @name        reatom-jsx-userscript
// @version     0.0.0
// @author      crashmax <userscript@crashmax.ru>
// @license     MIT
// @homepage    https://greasify.github.io/reatom-jsx-userscript/
// @match       http://localhost:3000
// @match       https://example.com
// @updateURL   https://greasify.github.io/reatom-jsx-userscript/reatom-jsx-userscript.meta.js
// @downloadURL https://greasify.github.io/reatom-jsx-userscript/reatom-jsx-userscript.user.js
// ==/UserScript==

(function(){"use strict";const je=Symbol(),me=function(e){try{return e(...[].slice.call(arguments,1))}catch(t){return setTimeout(()=>{throw t}),t instanceof Error?t:t=new Error(t)}};function $(e,t){if(e)throw new Error(`Reatom error: ${t}`)}const z=e=>e?.__reatom!==void 0,Ue=e=>e?.__reatom?.isAction===!0,B=e=>e.subs.size+e.listeners.size>0;function pe(e){$(typeof e!="function",`invalid "${typeof e}", function expected`)}const ke=e=>e.cause===null?e:ke(e.cause),Ze=()=>typeof window=="object"&&typeof document=="object";let U,Ye=0;const De=({callLateEffect:e=me,callNearEffect:t=me,restrictMultipleContexts:n=Ze()}={})=>{n&&Ye++==1&&console.warn("Reatom: multiple contexts detected, which is irrelevant in browser, you should use only one context");let o=new WeakMap,s=b=>o.get(b),f=new Set,r=[],a=[],p=!1,l=null,i=[],c=[],u=[],g=0,P=0,m=!1,S=()=>{for(let b of r)t(b,X);r=[]},A=()=>{if(!m){m=!0,S();for(let b of a)e(b,X),r.length>0&&S();a=[],m=!1}},k=({state:b,proto:h,pubs:w,subs:d,listeners:_},y)=>(h.actual=!1,u.push(h.patch={state:b,proto:h,cause:y,pubs:w,subs:d,listeners:_}),h.patch),F=b=>{for(let h of b.subs){let w=h.patch??s(h);h.patch&&!h.actual||k(w,b).listeners.size===0&&F(w)}},N=(b,h)=>{if(h.subs.delete(b)&&(c.push(()=>h.subs.add(b)),!B(h))){h.proto.disconnectHooks!==null&&r.push(...h.proto.disconnectHooks);for(let w of h.pubs)N(h.proto,w)}},G=(b,h)=>{if(!h.subs.has(b)){let w=B(h);if(h.subs.add(b),c.push(()=>h.subs.delete(b)),!w){h.proto.connectHooks!==null&&r.push(...h.proto.connectHooks);for(let d of(h.proto.patch??s(h.proto)).pubs)G(h.proto,d)}}},R=(b,h,w)=>{let{patch:d,actual:_}=h,y=w!==void 0;if(!y&&_&&(d.pubs.length===0||B(d)))return d;let v=d??s(h),Ge=!v,Xe=y?b.cause:s(he);if(Ge)v={state:h.initState(b),proto:h,cause:Xe,pubs:[],subs:new Set,listeners:new Set},y&&u.push(v);else if(h.computer===null&&!y)return v;d&&!_||(d=k(v,Xe));let{state:Vt}=d,K={get:b.get,spy:void 0,schedule:b.schedule,subscribe:b.subscribe,cause:d};try{h.computer&&((I,H)=>{let{proto:ve,pubs:q}=H,Ke=!1;if(q.length===0||q.some(({proto:O,state:L})=>!Object.is(L,(H.cause=R(I,O)).state))){let O=[];if(I.spy=({__reatom:L},M)=>{let ce=R(I,L),ue=O.push(ce)<=q.length?q[O.length-1]:void 0,fe=ue?.proto!==ce.proto;Ke||=fe;let de=L.isAction&&!fe?ce.state.slice(ue.state.length):ce.state;if(!M||!fe&&Object.is(de,ue.state))return de;if(L.isAction)for(const Jt of de)M(Jt);else M(de,fe?void 0:ue?.state)},H.state=H.proto.computer(I,H.state),H.pubs=O,(Ke||q.length>O.length)&&B(H)){for(let{proto:L}of q)O.every(M=>M.proto!==L)&&N(ve,L.patch??s(L));for(let{proto:L}of O)q.every(M=>M.proto!==L)&&G(ve,L.patch??s(L))}I.spy=()=>$(!0,"async spy"),H=ve=q=O=null}})(K,d),y&&(d.cause=b.cause,w(K,d)),h.actual=!0}catch(I){throw d.error=I}if(!Object.is(Vt,d.state)&&(d.subs.size>0&&(y||d.listeners.size>0)&&F(d),h.updateHooks)){let I={get:K.get,spy:void 0,schedule:K.schedule,subscribe:K.subscribe,cause:K.cause};h.updateHooks.forEach(H=>i.push(()=>H(I,d)))}return d},X={get(b){if($(U&&ke(U.cause)!==s(he),"cause collision"),z(b)){let d=b.__reatom;if(p)return R(this,d).state;let _=s(d);return _===void 0||d.computer!==null&&!B(_)?this.get(()=>R(this,d).state):_.state}if($(l!==null,"tr failed"),p)return b(s,R);p=!0,g=r.length,P=a.length;let h=U===void 0;h&&(U=this);try{var w=b(s,R);for(let d=0;d<u.length;d++){let{listeners:_,proto:y}=u[d];if(_.size>0&&R(this,y),i.length>0)for(let v of i.splice(0))v(this)}if(u.length)for(let d of f)d(u);for(let d of u){let{proto:_,state:y}=d;if(_.isAction&&(d.state=[]),d===_.patch)if(_.patch=null,_.actual=!1,o.set(_,d),_.isAction){if(y.length===0)continue;for(let v of d.listeners)r.push(()=>v(y))}else for(let v of d.listeners)a.push(()=>v(s(_).state))}}catch(d){l=d=d instanceof Error?d:new Error(String(d));for(let _ of f)_(u,d);for(let _ of c)me(_,d);for(let{proto:_}of u)_.patch=null,_.actual=!1;throw r.length=g,a.length=P,d}finally{p=!1,l=null,i=[],c=[],u=[],g=0,P=0,h&&(U=void 0)}return A(),w},spy:void 0,schedule(b,h=1){return pe(b),$(!this,"missed context"),new Promise((w,d)=>{h===-1?p&&c.push(b):h===0?p&&i.push(()=>b(this)):((h===1?r:a).push(()=>{try{let _=b(this);return _ instanceof Promise?_.then(w,d):w(_),_}catch(_){throw d(_),_}}),p||A())})},subscribe(b,h=b){if(pe(h),b===h)return f.add(h),()=>f.delete(h);$(!z(b),"target subscriber isn't an atom");let{__reatom:w}=b,d=je,_=v=>Object.is(d,v)||h(d=v),y=s(w);return y!==void 0&&B(y)?y.listeners.add(_):this.get(()=>{y=R(this,w,(v,Ge)=>{}),y.listeners.add(_),c.push(()=>w.patch.listeners.delete(_));for(let v of y.pubs)G(w,v);w.connectHooks!==null&&r.push(...w.connectHooks)}),d===je&&_((w.patch??s(w)).state),()=>{if(y.listeners.delete(_)&&!B(y)){w.disconnectHooks&&r.push(...w.disconnectHooks);for(let v of s(w).pubs)N(w,v);p||(c.length=0,A())}}},cause:void 0};return(X.cause=X.get(()=>R(X,he))).cause=null,X};let Qe=0,Q=e=>`${e}#${++Qe}`;function xe(){return[].slice.call(arguments).reduce((e,t)=>t(e),this)}function et(e){const t=(n,o)=>e(n,o.state);return(this.__reatom.updateHooks??=new Set).add(t),()=>this.__reatom.updateHooks.delete(t)}function tt(e){return this.onChange((t,n)=>{const{params:o,payload:s}=n[n.length-1];e(t,s,o)})}function C(e,t=Q("_atom")){let n=(s,f)=>s.get((r,a)=>a(s,n.__reatom,(p,l)=>{l.state=typeof f=="function"?f(l.state,p):f}).state),o=null;return typeof e=="function"&&(n={},o=e,e=void 0),n.__reatom={name:t,isAction:!1,patch:null,initState:()=>e,computer:o,connectHooks:null,disconnectHooks:null,updateHooks:null,actual:!1},n.pipe=xe,n.onChange=et,Pe.length===0?n:n.pipe(...Pe)}const j=(e,t)=>{e!==void 0&&typeof e!="string"||(t=e,e=(o,s)=>s),pe(e);let n=C([],t??Q("_action"));return n.__reatom.isAction=!0,n.__reatom.unstable_fn=e,Object.assign(function(){var o=[].slice.call(arguments);let s=n(o[0],(f,r)=>(o[0]=r,[...f,{params:o.slice(1),payload:r.cause.proto.unstable_fn(...o)}]));return s[s.length-1].payload},n,{onCall:tt})},Pe=[],he=C(void 0,"root").__reatom,T=()=>{},x=e=>typeof e=="object"&&e!==null,nt=e=>{if(!x(e))return!1;const t=Reflect.getPrototypeOf(e);return!t||!Reflect.getPrototypeOf(t)},ot=(e,t,n=Object.is)=>{if(Object.is(e,t))return!0;if(!x(e)||!x(t)||e.__proto__!==t.__proto__||e instanceof Error)return!1;if(Symbol.iterator in e){let o=e instanceof Map?(r,a)=>n(r[0],a[0])&&n(r[1],a[1]):n,s=e[Symbol.iterator](),f=t[Symbol.iterator]();for(;;){let r=s.next(),a=f.next();if(r.done||a.done||!o(r.value,a.value))return r.done&&a.done}}if(e instanceof Date)return e.getTime()===t.getTime();if(e instanceof RegExp)return String(e)===String(t);for(let o in e)if(o in t==0||!n(e[o],t[o]))return!1;return Object.keys(e).length===Object.keys(t).length},ee=Object.assign,Fe=function(){return Object.assign({},...[].slice.call(arguments))};let st=(e=0,t=Number.MAX_SAFE_INTEGER-1)=>Math.floor(Math.random()*(t-e+1))+e;const rt=(e,t)=>st(e,t),{toString:it}=Object.prototype;let at=0;const W=e=>{if(e instanceof Error==0||e.name!=="AbortError"){if(e instanceof Error){var t={cause:e};e=e.message}else e=x(e)?it.call(e):String(e);e+=` [${++at}]`,typeof DOMException>"u"?(e=new Error(e,t)).name="AbortError":e=ee(new DOMException(e,"AbortError"),t)}return e},ge=e=>{if(e?.signal.aborted)throw W(e.signal.reason)},te=e=>e instanceof Error&&e.name==="AbortError";Object.assign(function(){const e=globalThis.setTimeout(...[].slice.call(arguments));return typeof e=="number"?e:Object.assign(e,{toJSON:()=>-1})},globalThis.setTimeout);const Te=e=>t=>ee(t,e(t,t.__reatom.name)),lt=Symbol("Reatom linked list next"),Le=e=>e?.__reatomLinkedList===!0,Ne=e=>typeof e=="boolean"||e===""||e==null;let V=new WeakMap,ne=(e,t)=>{Promise.resolve().then(()=>{if(!e.isConnected)t();else for(;e.parentElement&&!V.get(e)?.push(()=>e.isConnected||t());)e=e.parentElement})};const ct=(e,t,n,o)=>{let s=-1;const f=p=>{if(p.version-1>s){n.innerHTML="";for(let{head:l}=p;l;l=l[lt])$e(l),n.append(l)}else{let l;for(const i of p.changes)if(i.kind==="create"?($e(i.node),l??=t.document.createDocumentFragment(),l.append(i.node)):l&&(n.append(l),l=void 0),i.kind==="remove")if(ut(i.node)){const c=i.node.__reatomFragment;c.update(),c.start.remove(),c.end.remove()}else n.removeChild(i.node);else if(i.kind==="swap"){let[c,u]=[i.a.nextSibling,i.b.nextSibling];u?n.insertBefore(i.a,u):n.append(i.a),c?n.insertBefore(i.b,c):n.append(i.b)}else i.kind==="move"?i.after?i.after.insertAdjacentElement("afterend",i.node):n.append(i.node):i.kind==="clear"&&(n.innerHTML="");l&&n.append(l)}s=p.version},r=e.subscribe(o,T),a=o.onChange((p,l)=>f(l));f(e.get(o)),ne(n,()=>{r(),a()})},ut=e=>String(e)==="[object DocumentFragment]"&&"__reatomFragment"in e,$e=e=>{$(String(e)==="[object DocumentFragment]"&&!("__reatomFragment"in e),"native fragment is not supported")},He=(e,t)=>{const n=e.document.createDocumentFragment(),o=e.document.createComment(t),s=o.cloneNode();return n.append(o,s),Object.assign(n,{__reatomFragment:{start:o,end:s,update:r=>{for(;o.nextSibling&&o.nextSibling!==s;)o.nextSibling.remove?.();if(r instanceof e.Node)o.after(r);else if(!Ne(r)){const a=z(r)?oe(Ie,e,r):e.document.createTextNode(String(r));o.after(a)}}}})},oe=(e,t,n)=>{const o=He(t,n.__reatom.name),s=e.subscribe(n,o.__reatomFragment.update);return V.set(o.__reatomFragment.start,[]),ne(o.__reatomFragment.start,s),o},Re=(e,t,n)=>{n==null?e.removeProperty(t):e.setProperty(t,n)},ft=(e,t=globalThis.window,{stylesheetContainer:n=t.document.head}={})=>{const o={};let s=(n??t.document.head).appendChild(t.document.createElement("style")),f="",r=(i,c,u)=>{if(c.startsWith("on:"))c=c.slice(3),u=j(u,`${f}.${i.nodeName.toLowerCase()}._${c}`),i.addEventListener(c,g=>u(e,g));else if(c.startsWith("css:"))c="--"+c.slice(4),u==null?i.style.removeProperty(c):i.style.setProperty(c,String(u));else if(c==="css"){const g=f?f+"_":"",P=g+u;let m=o[P];m||(m=o[P]=g+rt(0,1e6).toString(),s.innerText+='[data-reatom="'+m+'"]{'+u+`}
`),i.setAttribute("data-reatom",m)}else if(c==="style"&&typeof u=="object")for(const g in u)Re(i.style,g,u[g]);else c.startsWith("style:")?(c=c.slice(6),Re(i.style,c,u)):c.startsWith("prop:")?i[c.slice(5)]=u:(c.startsWith("attr:")&&(c=c.slice(5)),c==="className"&&(c="class"),u==null||u===!1?i.removeAttribute(c):(u=u===!0?"":String(u),c==="class"&&i instanceof HTMLElement?i.className=u:i.setAttribute(c,u)))},a=(i,c,...u)=>{if(z(i))return oe(e,t,i);if(i===p){const m=He(t,"");for(let S=0;S<u.length;S++){const A=u[S];m.append(z(A)?oe(e,t,A):A)}return m.append(m.__reatomFragment.end),m}c??={};let g;if(typeof i=="function")if(i===mt)g=c.element,c.element=void 0;else{u.length&&(c.children=u);let m=f;try{return f=i.name,i(c)}finally{f=m}}else g=i.startsWith("svg:")?t.document.createElementNS("http://www.w3.org/2000/svg",i.slice(4)):t.document.createElement(i);"children"in c&&(u=c.children);for(let m in c)if(m!=="children"&&m!=="element"){let S=c[m];if(m==="ref")e.schedule(()=>{const A=S(e,g);if(typeof A=="function"){let k=V.get(g);k||V.set(g,k=[]),ne(g,()=>A(e,g))}});else if(z(S)&&!S.__reatom.isAction){if(m.startsWith("model:")){let k=m=m.slice(6);r(g,"on:input",(F,N)=>{S(F,k==="valueAsNumber"?+N.target.value:N.target[k])}),m==="valueAsNumber"&&(m="value",r(g,"type","number")),m==="checked"&&r(g,"type","checkbox"),m="prop:"+m}let A;A=e.subscribe(S,k=>!A||g.isConnected?m==="$spread"?Object.entries(k).forEach(([F,N])=>r(g,F,N)):r(g,m,k):A()),ne(g,A)}else r(g,m,S)}let P=m=>{if(Array.isArray(m))for(let S=0;S<m.length;S++)P(m[S]);else Le(m)?ct(e,t,g,m):z(m)?g.append(oe(e,t,m)):Ne(m)||g.append(m)};for(let m=0;m<u.length;m++)P(u[m]);return g},p=()=>{};return{h:a,hf:p,mount:(i,c)=>{i.append(c),new t.MutationObserver(u=>{for(let g of u)for(let P of g.removedNodes){const m=t.document.createTreeWalker(P,129);do{const S=m.currentNode;V.get(S)?.forEach(A=>A()),V.delete(S)}while(m.nextNode())}}).observe(i.parentElement,{childList:!0,subtree:!0})}}},Ie=De({restrictMultipleContexts:!1}),{h:E,mount:dt}=ft(Ie),mt=e=>e.element;function pt(e,t){try{var n=e()}catch(o){return t(o)}return n&&n.then?n.then(void 0,t):n}class Oe extends WeakMap{has(t){return super.has(t)||t.cause!==null&&this.has(t.cause)}get(t){for(;!super.has(t)&&t.cause;)t=t.cause;return super.get(t)}}const Z=new Oe,ze=e=>Z.get(e)??null,be=(e,t)=>{const n=ze(e.cause);if(n){const o=()=>t(W(n.signal.reason)),s=()=>n.signal.removeEventListener("abort",o);if(!n.signal.aborted)return n.signal.addEventListener("abort",o),s;o()}},_e=new WeakMap,se=(e,t,n,o)=>{let s=_e.get(t);if(!s){const f=t.then(r=>(e.get((a,p)=>s.then.forEach(l=>l(r,a,p))),r),r=>{throw e.get((a,p)=>s.catch.forEach(l=>l(r,a,p))),te(r)&&f.catch(T),r});_e.set(t,s={promise:f,then:[],catch:[]}),_e.set(f,s)}return n&&s.then.push(n),o&&s.catch.push(o),s.promise},Se=e=>{const{schedule:t}=e;return Fe(e,{schedule(n,o=1){const s=this;if(o<1)return t.call(this,n,o);let f,r;const a=new Promise((l,i)=>{f=l,r=i}),p=be(this,l=>{a.catch(T),r(l)});return t.call(this,function(l){try{let i=function(){p?.()};const c=pt(function(){const u=ze(s.cause);return ge(u),Promise.resolve(n(l)).then(function(g){ge(u),f(g)})},function(u){r(u)});return Promise.resolve(c&&c.then?c.then(i):i())}catch(i){return Promise.reject(i)}},o).catch(l=>{r(l),p?.()}),a}})};j(function(e,t,n){return Z.set(e.cause,n),t(e,...[].slice.call(arguments,3))},"_spawn");const re=e=>e.cause===null?e:re(e.cause),ht=(e,t)=>re(e.cause)===re(t.cause),gt=(e,t)=>(e.__reatom.connectHooks??=new Set).add(t),bt=(e,t)=>(e.__reatom.disconnectHooks??=new Set).add(t),_t=e=>t=>{const{initState:n,isAction:o}=t.__reatom;return $(o,"action state is not manageable"),t.__reatom.initState=s=>e(s,n),t},St=j((e,t,n,o)=>{e.cause.cause=re(e.cause),Z.set(e.cause,o);const s=n(Se({...e,controller:o,isConnected:()=>We(e,t)}));return s instanceof Promise&&o.signal.addEventListener("abort",()=>s.catch(T)),s},"_onConnect"),ie=(e,t)=>{const n=s=>{const f=new AbortController,r=St(s,e,t,f);r instanceof Promise&&r.catch(T);const a=l=>{ht(s,l)&&p.delete(a)&&o.has(n)&&(f.abort(W("disconnect "+e.__reatom.name)),typeof r=="function"&&r())},p=bt(e,a)},o=gt(e,n);return()=>o.delete(n)},We=(e,{__reatom:t})=>e.get(n=>{const o=t.patch??n(t);return!!o&&o.subs.size+o.listeners.size>0}),wt=C(null,"initializations");wt.__reatom.initState=()=>new WeakMap;const Et=(e,t,{shouldPending:n=!0,shouldFulfill:o=!0,shouldReject:s=!0,effect:f=e.__reatom.unstable_fn}={})=>{const r=e.pendingAtom,[a]=t;n&&r(a,l=>++l);const p=a.schedule(()=>new Promise((l,i)=>{ge(a.controller),f(...t).then(l,i),a.controller.signal.addEventListener("abort",()=>i(W(a.controller.signal.reason)))}));return ee(se(a,p,l=>{o&&e.onFulfill(a,l),n&&r(a,i=>--i)},l=>{s&&!te(l)&&e.onReject(a,l),n&&r(a,i=>--i)}),{controller:a.controller})},we=e=>t=>{const n=e(t);return ot(t,n)?t:n},qe={isPending:!1,isFulfilled:!1,isRejected:!1,isSettled:!1,isFirstPending:!1,isEverPending:!1,isEverSettled:!1},At=()=>e=>{if(!e.statusesAtom){const t=C(new WeakSet,`${e.__reatom.name}.statusesAtom._relatedPromisesAtom`),n=C(null,`${e.__reatom.name}.statusesAtom._lastSettledStatusAtom`),o=C(qe,`${e.__reatom.name}.statusesAtom`);o.__reatom.computer=(s,f)=>(s.spy(e,({payload:r})=>{s.get(t).add(r);const a=s.get(e.pendingAtom);f=we(p=>({isPending:a>0,isFulfilled:!1,isRejected:!1,isSettled:!1,isFirstPending:!p.isEverPending,isEverPending:!0,isEverSettled:p.isEverSettled}))(f)}),f),e.statusesAtom=Object.assign(o,{reset:j(s=>(t(s,new Set),o(s,qe)))}),e.onCall((s,f)=>{s.get(o),se(s,f,()=>{s.get(t).has(f)&&(o(s,we(()=>{const r=s.get(e.pendingAtom)>0;return{isPending:r,isFulfilled:!r,isRejected:!1,isSettled:!r,isFirstPending:!1,isEverPending:!0,isEverSettled:!0}})),n(s,"fulfilled"))},r=>{if(s.get(t).has(f)){const a=s.get(e.pendingAtom)>0;o(s,we(p=>{if(te(r)){const l=s.get(n);return p.isEverSettled&&!a?{isPending:a,isFulfilled:l==="fulfilled",isRejected:l==="rejected",isSettled:!0,isFirstPending:!1,isEverPending:!0,isEverSettled:!0}:{isPending:a,isFulfilled:!1,isRejected:!1,isSettled:!1,isFirstPending:!1,isEverPending:!0,isEverSettled:p.isEverSettled}}return{isPending:a,isFulfilled:!1,isRejected:!a,isSettled:!a,isFirstPending:!1,isEverPending:!0,isEverSettled:!0}})),te(r)||n(s,"rejected")}})})}return e},Ee=new WeakSet,yt=(e,t=Q("asyncAtom"))=>{const n=new Oe,o=ye(r=>{const a=n.get(r.cause);return $(!a,"reaction manual call"),a},t),s=C((r,a)=>{if(a&&!r.cause.pubs.length)return a;const p=[],l=Fe(r,{spy(F,N){$(N,"spy reactions are unsupported in ResourceAtom");const G=r.spy(F);return p.push(G),G}}),i=W("concurrent "+t),c=new AbortController,u=be(l,F=>{i!==F&&!We(l,f)&&c.abort(F)});u&&c.signal.addEventListener("abort",u),Z.set(l.cause,l.controller=c);const g=e(Se(l));g.catch(T),n.set(l.cause,g);const P=l.get(o.pendingAtom),m=l.get(o.onFulfill);let S=o(l,...p);S.controller.signal.addEventListener("abort",()=>{f.cacheAtom?.options.ignoreAbort||c.abort(S.controller.signal.reason)});const A=P===l.get(o.pendingAtom),k=l.get(o.onFulfill);return A&&c.abort(W("cached "+t)),A&&m!==k&&(S=Object.assign(Promise.resolve(k[k.length-1].payload),{controller:c})),se(l,S,()=>Ee.add(S),()=>Ee.add(S)).catch(T),a?.controller.abort(i),S},`${t}._promiseAtom`);ie(o,r=>r.subscribe(s,T)),ie(s,r=>()=>{r.get(a=>{const p=a(s.__reatom)?.state;p?.controller.abort(r.controller.signal.reason),Ee.has(p)||Ae(r,s.__reatom,r.controller.signal.reason)})});const f=Object.assign(r=>r.get((a,p)=>{Ae(r,s.__reatom,W("force "+t)),p(r,s.__reatom,T);const l=r.get(o),i=l[l.length-1]?.payload;return $(!i,"unexpectedly failed invalidation. Please, report the issue"),i}),o,{promiseAtom:s,init(r){return r.subscribe(s,T)},reset:j(r=>{Ae(r,s.__reatom,W("reset "+t))},`${t}.reset`)});return Object.defineProperty(o,"_handleCache",{get(){return f._handleCache}}),f},Ae=(e,t,n)=>e.get((o,s)=>{if(o(t)){const{computer:f}=t;t.computer=null;try{s(e,t,(r,a)=>{a.state?.controller.abort(n),a.pubs=[],a.state=void 0})}finally{t.computer=f}}}),ye=(e,t={})=>{const{name:n=Q("async"),onEffect:o,onFulfill:s,onReject:f,onSettle:r}=typeof t=="string"?{name:t}:t,a=C(0,`${n}.pendingAtom`),p=Object.assign((...u)=>u[0].get((g,P)=>{const{state:m}=P(u[0],p.__reatom,(S,A)=>{Z.set(S.cause,S.controller=new AbortController);const k=be(u[0],N=>{F?.catch(T),S.controller.abort(N)});k&&S.controller.signal.addEventListener("abort",k),u[0]=Se(S);var F=p._handleCache?p._handleCache(...u):Et(p,u);se(S,F,void 0,()=>{i.__reatom.updateHooks.size>1&&F.catch(T)}),A.state=[...A.state,{params:u.slice(1),payload:F}]});return m[m.length-1].payload}),j(e,n)),l=j(`${n}.onFulfill`),i=j(`${n}.onReject`),c=j(`${n}._onSettle`);return l.onCall(u=>c(u)),i.onCall(u=>c(u)),o&&p.onCall((u,g,P)=>o(u,P,g)),s&&l.onCall(s),f&&i.onCall(f),r&&c.onCall(r),ie(a,u=>u.subscribe(p,T)),ee(p,{onFulfill:l,onReject:i,onSettle:c,pendingAtom:a})};ye.from=(e,t={})=>(e.name.length>2&&(typeof t=="object"?t.name??=e.name:t??=e.name),ye((n,...o)=>e(...o),t));const Ct=(e,t)=>n=>{if(!n.dataAtom){const o=n.dataAtom=Object.assign(C(e,`${n.__reatom.name}.dataAtom`),{reset:j(s=>{o(s,e)},`${n.__reatom.name}.dataAtom.reset`),mapFulfill:t});o.__reatom.computer=(s,f)=>(s.spy(n.onFulfill,({payload:r})=>{f=r}),f),n.onFulfill.onCall(s=>{s.get(o)}),ie(o,s=>s.subscribe(n,T))}return n},Y=(e,t)=>{if(Ue(t))return t;for(Le(t)&&(t=t.array);z(t);)t=e.spy?e.spy(t):e.get(t);if(typeof t!="object"||t===null)return t;if(nt(t)){const n={};for(const o in t)n[o]=Y(e,t[o]);return n}if(Array.isArray(t)){const n=[];for(const o of t)n.push(Y(e,o));return n}if(t instanceof Map){const n=new Map;for(const[o,s]of t)n.set(o,Y(e,s));return n}if(t instanceof Set){const n=new Set;for(const o of t)n.add(Y(e,o));return n}return t},vt=C(null,"select._map");vt.__reatom.initState=()=>new WeakMap;const jt=()=>e=>Object.assign(e,{reset:j(t=>t.get((n,o)=>o(t,e.__reatom,(s,f)=>f.state=f.proto.initState(t)).state),`${e.__reatom.name}._reset`)}),D=C(16,"fontSizeAtom").pipe(Te((e,t)=>({increment:j(n=>e(n,o=>o+1),`${t}.increment`),decrement:j(n=>e(n,o=>o-1),`${t}.decrement`)})),jt()),kt=C(e=>e.spy(D)+"px","fontSizeVariableAtom");function Pt(){return E("div",null,E("h1",{css:"font-size: var(--size)","css:size":kt},"Font size: ",D),E("button",{"on:click":D.increment},"Increment"),E("button",{"on:click":D.decrement},"Decrement"),E("button",{"on:click":D.reset},"Reset"))}const Ft=["get","post","put","patch","delete","head","options"];class Tt extends Error{response;data;constructor({message:t,response:n,data:o}){super(t),this.name="FetchError",this.response=n,this.data=o}}function Lt(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}function Nt(...e){const t={};for(const n of e){const o=new Headers(n);for(const[s,f]of o.entries())t[s]=f}return new Headers(t)}class Ce{#t;#e;get;post;put;patch;delete;head;options;constructor(t,n={}){this.#t=t,this.#e=n;for(const o of Ft)this[o]=(s,f)=>this.request(s,{...f,method:o})}extends(t,n){const o=this.fetcherParameters(t,n);return new Ce(...o)}async request(t,n){n?.params&&(t=this.pathParams(t,n.params),delete n.params);const o=this.fetcherParameters(t,n);return await $t(...o)}fetcherParameters(t,n){const o=Lt(this.#t,t),s=Nt(this.#e.headers,n?.headers),f={...this.#e,...n,headers:s};return[o,f]}pathParams(t,n){for(const[o,s]of Object.entries(n))t=t.replace(`:${o}`,`${s}`);return t}}async function $t(...e){const t=await fetch(...e),n=await t.json();if(!t.ok)throw new Tt({message:t.statusText,response:t,data:n});return n}const Ht=new Ce("https://jsonplaceholder.typicode.com").extends("posts"),ae=C(1,"todoPageAtom").pipe(Te((e,t)=>({nextTodo:j(n=>e(n,o=>o+1),`${t}.nextTodo`),prevTodo:j(n=>e(n,o=>Math.max(1,o-1)),`${t}.prevTodo`)}))),Be=yt(e=>{const t=e.spy(ae);return e.schedule(()=>Ht.get(`${t}`,{signal:e.controller.signal}))},"todoResource").pipe(Ct(null),At()),Rt=C(e=>e.spy(Be.dataAtom)?.title,"todoAtom"),It=C(e=>e.spy(Be.statusesAtom).isPending,"todoIsLoadingAtom");function Ot(){return E("div",null,E("button",{"on:click":ae.prevTodo},"Prev"),E("button",{"on:click":ae.nextTodo},"Next"),E("h1",null,"Page: ",ae),C(e=>E("b",{style:{display:"block",height:"1rem"}},e.spy(It)?"Loading...":E("pre",null,Rt))))}const le=C("","inputAtom"),Me="todos";function zt(){const e=localStorage.getItem(Me);return e?JSON.parse(e).map(n=>Je(n.title,n.completed)):[]}const Ve=j(e=>{const t=JSON.stringify(Y(e,J));localStorage.setItem(Me,t)},"toLocalStorage"),J=C([],"todosAtom").pipe(_t(zt));J.onChange(Ve);function Je(e,t){const n=C(t,`completed#${e}`);return n.onChange(Ve),{title:e,completed:n}}const Wt=j((e,t)=>{t.preventDefault();const n=e.get(le);if(!n){alert("Title is required");return}if(e.get(J).find(s=>s.title===n)){alert("Todo already exists");return}J(e,s=>[...s,Je(n,!1)]),le(e,"")},"addTodo"),qt=j(e=>{J(e,[]),le(e,"")},"clearTodos");function Bt(){return E("div",null,E("h1",null,"Todo list"),E("form",{"on:submit":Wt},E("input",{required:!0,autofocus:!0,"model:value":le}),E("button",null,"Add"),E("button",{type:"button","on:click":qt},"Clear")),C(e=>E("ul",null,e.spy(J).map(t=>E("li",{style:{"text-decoration":e.spy(t.completed)?"line-through":"none"}},E("span",null,t.title),E("input",{type:"checkbox","model:checked":t.completed}))))))}function Mt(){return E("section",null,E(Pt,null),E(Ot,null),E(Bt,null))}dt(document.body,E(Mt,null))})();
