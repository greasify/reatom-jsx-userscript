// ==UserScript==
// @name        reatom-jsx-userscript
// @version     0.0.0
// @author      crashmax <userscript@crashmax.ru>
// @license     MIT
// @homepage    https://greasify.github.io/reatom-jsx-userscript/
// @match       http://localhost:3000
// @match       https://example.com
// @updateURL   https://greasify.github.io/reatom-jsx-userscript/reatom-jsx-userscript.meta.js
// @downloadURL https://greasify.github.io/reatom-jsx-userscript/reatom-jsx-userscript.user.js
// ==/UserScript==

(function(){"use strict";const ve=Symbol(),me=function(e){try{return e(...[].slice.call(arguments,1))}catch(t){return setTimeout(()=>{throw t}),t instanceof Error?t:t=new Error(t)}};function O(e,t){if(e)throw new Error(`Reatom error: ${t}`)}const Q=e=>e?.__reatom!==void 0,W=e=>e.subs.size+e.listeners.size>0;function pe(e){O(typeof e!="function",`invalid "${typeof e}", function expected`)}const Pe=e=>e.cause===null?e:Pe(e.cause);let G;const Ve=({callLateEffect:e=me,callNearEffect:t=me}={})=>{let s=new WeakMap,o=_=>s.get(_),n=new Set,c=[],a=[],i=!1,d=null,r=[],l=[],m=[],u=0,C=0,b=!1,E=()=>{for(let _ of c)t(_,N);c=[]},g=()=>{if(!b){b=!0,E();for(let _ of a)e(_,N),c.length>0&&E();a=[],b=!1}},h=({state:_,proto:f,pubs:A,subs:p,listeners:w},P)=>(f.actual=!1,m.push(f.patch={state:_,proto:f,cause:P,pubs:A,subs:p,listeners:w}),f.patch),S=_=>{for(let f of _.subs.keys()){let A=f.patch??o(f);f.patch&&!f.actual||h(A,_).listeners.size===0&&S(A)}},T=(_,f)=>{if(f.subs.delete(_)&&(l.push(()=>f.subs.add(_)),!W(f))){f.proto.disconnectHooks!==null&&c.push(...f.proto.disconnectHooks);for(let A of f.pubs)T(f.proto,A)}},j=(_,f)=>{if(!f.subs.has(_)){let A=W(f);if(f.subs.add(_),l.push(()=>f.subs.delete(_)),!A){f.proto.connectHooks!==null&&c.push(...f.proto.connectHooks);for(let p of f.pubs)j(f.proto,p)}}},L=(_,f,A)=>{let{patch:p,actual:w}=f,P=A!==void 0;if(!P&&w&&(p.pubs.length===0||W(p)))return p;let $=p??o(f),qe=!$,Ge=P?_.cause:o(Z);if(qe)$={state:f.initState(_),proto:f,cause:Ge,pubs:[],subs:new Set,listeners:new Set};else if(f.computer===null&&!P)return $;p&&!w||(p=h($,Ge));let{state:Nt}=p,q={get:_.get,spy:void 0,schedule:_.schedule,subscribe:_.subscribe,cause:p};try{f.computer&&((M,F)=>{let{proto:Je,pubs:k}=F,Ue=!1;if(k.length===0||k.some(({proto:z,state:R})=>!Object.is(R,(F.cause=L(M,z)).state))){let z=[];if(M.spy=({__reatom:R},D)=>{if(F.pubs===k){let le=L(M,R),ce=z.push(le)<=k.length?k[z.length-1]:void 0,ue=ce?.proto!==le.proto;Ue||=ue;let de=R.isAction&&!ue?le.state.slice(ce.state.length):le.state;if(!D||!ue&&Object.is(de,ce.state))return de;if(R.isAction)for(const Ft of de)D(Ft);else D(de,ue?void 0:ce?.state)}else O(!0,"async spy")},F.state=F.proto.computer(M,F.state),F.pubs=z,(Ue||k.length>z.length)&&W(F)){for(let{proto:R}of k)z.every(D=>D.proto!==R)&&T(Je,R.patch??o(R));for(let{proto:R}of z)k.every(D=>D.proto!==R)&&j(Je,R.patch??o(R))}}})(q,p),P&&(p.cause=_.cause,A(q,p)),f.actual=!0}catch(M){throw p.error=M}if(!Object.is(Nt,p.state)&&(p.subs.size>0&&(P||p.listeners.size>0)&&S(p),f.updateHooks)){let M={get:q.get,spy:void 0,schedule:q.schedule,subscribe:q.subscribe,cause:q.cause};f.updateHooks.forEach(F=>r.push(()=>F(M,p)))}return p},N={get(_){if(O(G&&Pe(G.cause)!==o(Z),"cause collision"),Q(_)){let p=_.__reatom;if(i)return L(this,p).state;let w=o(p);return w===void 0||p.computer!==null&&!W(w)?this.get(()=>L(this,p).state):w.state}if(O(d!==null,"tr failed"),i)return _(o,L);i=!0,u=c.length,C=a.length;let f=G===void 0;f&&(G=this);try{var A=_(o,L);for(let p=0;p<m.length;p++){let{listeners:w,proto:P}=m[p];if(w.size>0&&L(this,P),r.length>0)for(let $ of r.splice(0))$(this)}if(m.length)for(let p of n)p(m);for(let p of m){let{proto:w,state:P}=p;if(w.isAction&&(p.state=[]),p===w.patch)if(w.patch=null,w.actual=!1,s.set(w,p),w.isAction){if(P.length===0)continue;for(let $ of p.listeners)c.push(()=>$(P))}else for(let $ of p.listeners)a.push(()=>$(o(w).state))}}catch(p){d=p=p instanceof Error?p:new Error(String(p));for(let w of n)w(m,p);for(let w of l)me(w,p);for(let{proto:w}of m)w.patch=null,w.actual=!1;throw c.length=u,a.length=C,p}finally{i=!1,d=null,r=[],l=[],m=[],u=0,C=0,f&&(G=void 0)}return g(),A},spy:void 0,schedule(_,f=1){return pe(_),O(!this,"missed context"),new Promise((A,p)=>{f===-1?i&&l.push(_):f===0?i&&r.push(()=>_(this)):((f===1?c:a).push(()=>{try{let w=_(this);return w instanceof Promise?w.then(A,p):A(w),w}catch(w){throw p(w),w}}),i||g())})},subscribe(_,f=_){if(pe(f),_===f)return n.add(f),()=>n.delete(f);let{__reatom:A}=_,p=ve,w=$=>Object.is(p,$)||f(p=$),P=o(A);return P!==void 0&&W(P)?P.listeners.add(w):this.get(()=>{P=L(this,A,($,qe)=>{}),P.listeners.add(w),l.push(()=>A.patch.listeners.delete(w)),A.connectHooks!==null&&c.push(...A.connectHooks);for(let $ of P.pubs)j(A,$)}),p===ve&&w((A.patch??o(A)).state),()=>{if(P.listeners.delete(w)&&!W(P)){A.disconnectHooks&&c.push(...A.disconnectHooks);for(let $ of P.pubs)T(A,$);i||(l.length=0,g())}}},cause:void 0};return(N.cause=N.get(()=>L(N,Z))).cause=null,N};let Xe=0,Y=e=>`${e}#${++Xe}`;function Ke(){return[].slice.call(arguments).reduce((e,t)=>t(e),this)}function Qe(e){const t=(s,o)=>e(s,o.state);return(this.__reatom.updateHooks??=new Set).add(t),()=>this.__reatom.updateHooks.delete(t)}function Ye(e){return this.onChange((t,s)=>{const{params:o,payload:n}=s[s.length-1];e(t,n,o)})}function y(e,t=Y("_atom")){let s=(n,c)=>n.get((a,i)=>i(n,s.__reatom,(d,r)=>{r.state=typeof c=="function"?c(r.state,d):c}).state),o=null;return typeof e=="function"&&(s={},o=e,e=void 0),s.__reatom={name:t,isAction:!1,patch:null,initState:()=>e,computer:o,connectHooks:null,disconnectHooks:null,updateHooks:null,actual:!1},s.pipe=Ke,s.onChange=Qe,je.length===0?s:s.pipe(...je)}const I=(e,t)=>{e!==void 0&&typeof e!="string"||(t=e,e=(o,n)=>n),pe(e);let s=y([],t??Y("_action"));return s.__reatom.isAction=!0,s.__reatom.unstable_fn=e,Object.assign(function(){var o=[].slice.call(arguments);let n=s(o[0],(c,a)=>(o[0]=a,[...c,{params:o.slice(1),payload:a.cause.proto.unstable_fn(...o)}]));return n[n.length-1].payload},s,{onCall:Ye})},je=[],Z=y(void 0,"root").__reatom,H=()=>{},x=e=>typeof e=="object"&&e!==null,Ze=e=>{if(!x(e))return!1;const t=Reflect.getPrototypeOf(e);return!t||!Reflect.getPrototypeOf(t)},xe=(e,t,s=Object.is)=>{if(Object.is(e,t))return!0;if(!x(e)||!x(t)||e.__proto__!==t.__proto__||e instanceof Error)return!1;if(Symbol.iterator in e){let o=e instanceof Map?(a,i)=>s(a[0],i[0])&&s(a[1],i[1]):s,n=e[Symbol.iterator](),c=t[Symbol.iterator]();for(;;){let a=n.next(),i=c.next();if(a.done||i.done||!o(a.value,i.value))return a.done&&i.done}}if(e instanceof Date)return e.getTime()===t.getTime();if(e instanceof RegExp)return String(e)===String(t);for(let o in e)if(o in t==0||!s(e[o],t[o]))return!1;return Object.keys(e).length===Object.keys(t).length},fe=Object.assign,ee=function(){return Object.assign({},...[].slice.call(arguments))},Te=(e=0,t=Number.MAX_SAFE_INTEGER-1)=>Math.floor(Math.random()*(t-e+1))+e,{toString:et}=Object.prototype,B=e=>{if(e instanceof Error==0||e.name!=="AbortError"){if(e instanceof Error){var t={cause:e};e=e.message}else e=x(e)?et.call(e):String(e);typeof DOMException>"u"?(e=new Error(e,t)).name="AbortError":e=fe(new DOMException(e,"AbortError"),t)}return e},he=e=>{if(e?.signal.aborted)throw B(e.signal.reason)},$e=e=>e instanceof Error&&e.name==="AbortError",Le=2**31-1,tt=(e,t=globalThis.window)=>{let s,o=new WeakMap,n={},c="",a=(r,l,m)=>{if(l.startsWith("on:"))l=l.slice(3),m=I(m,`${c}.${r.nodeName.toLowerCase()}.${l}`),r.addEventListener(l,u=>m(e,u));else if(l.startsWith("css:"))l="--"+l.slice(4),m==null?r.style.removeProperty(l):r.style.setProperty(l,String(m));else if(l==="css"){s??=t.document.getElementById("reatom-jsx-styles"),s||(s=t.document.createElement("style"),s.id="reatom-jsx-styles",t.document.head.appendChild(s));let u=n[m];u||(u=n[m]="reatom-"+Te(),s.innerText+="."+u+"{"+m+`}
`),r.classList.add(u)}else if(l==="style"&&typeof m=="object")for(const u in m)m[u]==null?r.style.removeProperty(u):r.style.setProperty(u,m[u]);else l.startsWith("prop:")?r[l.slice(5)]=m:(l.startsWith("attr:")&&(l=l.slice(5)),m==null?r.removeAttribute(l):r.setAttribute(l,String(m)))},i=(r,l)=>{Promise.resolve().then(()=>{if(r.isConnected)for(;r.parentElement&&!o.get(r)?.push(l);)r=r.parentElement;else l()})},d=()=>{};return{h:function(r,l){var m=[].slice.call(arguments,2);if(r===d)return m;if(typeof r=="function"){(l??={}).children=m;let b=r.name;try{return c=r.name,r(l)}finally{c=b}}let u=r.startsWith("svg:")?t.document.createElementNS("http://www.w3.org/2000/svg",r.slice(4)):t.document.createElement(r);for(let b in l){let E=l[b];if(Q(E)&&!E.__reatom.isAction){if(b.startsWith("model:")){let h=b=b.slice(6);a(u,"on:input",(S,T)=>{E(S,h==="valueAsNumber"?+T.target.value:T.target[h])}),b==="valueAsNumber"&&(b="value"),b="prop:"+b}let g;g=e.subscribe(E,h=>!g||u.isConnected?b==="$spread"?Object.entries(h).forEach(([S,T])=>a(u,S,T)):a(u,b,h):g()),i(u,g)}else a(u,b,E)}let C=b=>{if(Array.isArray(b))b.forEach(C);else if(Q(b)){let E,g=t.document.createTextNode("");E=e.subscribe(b,h=>{if(E&&!g.isConnected)E();else if(O(Array.isArray(h),"array children are not supported"),h instanceof t.HTMLElement){let S=o.get(h);S||o.set(h,S=[]),E&&u.replaceChild(h,g),g=h}else g.textContent=h}),i(u,E),u.appendChild(g)}else u.appendChild(b?.nodeType?b:t.document.createTextNode(String(b)))};return m.forEach(C),u},hf:d,mount:(r,l)=>{Array.isArray(l)?r.append(...[l].flat(1/0)):r.appendChild(l),new t.MutationObserver(m=>{for(let u of m)for(let C of u.removedNodes){let b=o.get(C);b&&(b.forEach(E=>E()),o.delete(C))}}).observe(r,{childList:!0,subtree:!0})}}},ot=Ve(),{h:v,hf:st,mount:nt}=tt(ot);function rt(e,t){try{var s=e()}catch(o){return t(o)}return s&&s.then?s.then(void 0,t):s}class Re extends WeakMap{has(t){return super.has(t)||t.cause!==null&&this.has(t.cause)}get(t){for(;!super.has(t)&&t.cause;)t=t.cause;return super.get(t)}}const te=new Re,He=e=>te.get(e)??null,ge=(e,t)=>{const s=He(e.cause);if(s){const o=()=>t(B(s.signal.reason)),n=()=>s.signal.removeEventListener("abort",o);if(!s.signal.aborted)return s.signal.addEventListener("abort",o),e.schedule(()=>s.signal.removeEventListener("abort",o),-1),n;o()}},be=new WeakMap,oe=(e,t,s,o)=>{let n=be.get(t);if(!n){const c=t.then(a=>(e.get((i,d)=>n.then.forEach(r=>r(a,i,d))),a),a=>{throw e.get((i,d)=>n.catch.forEach(r=>r(a,i,d))),$e(a)&&c.catch(H),a});be.set(t,n={promise:c,then:[],catch:[]}),be.set(c,n)}return s&&n.then.push(s),o&&n.catch.push(o),n.promise},Oe=e=>{const{schedule:t}=e;return ee(e,{schedule(s,o){const n=this;if(o===-1)return t.call(this,s,o);let c,a;const i=new Promise((r,l)=>{c=r,a=l}),d=ge(this,r=>{i.catch(H),a(r)});return t.call(this,function(r){try{let l=function(){d?.()};const m=He(n.cause),u=rt(function(){return he(m),Promise.resolve(s(r)).then(function(C){he(m),c(C)})},function(C){a(C)});return Promise.resolve(u&&u.then?u.then(l):l())}catch(l){return Promise.reject(l)}},o),i}})},se=e=>e.cause===null?e:se(e.cause),at=(e,t)=>se(e.cause)===se(t.cause),it=(e,t)=>(e.__reatom.connectHooks??=new Set).add(t),lt=(e,t)=>(e.__reatom.disconnectHooks??=new Set).add(t),J=(e,t)=>{const s=n=>{const c=ee(n.get(l=>l(e.__reatom)),{cause:se(n.cause)}),a=new AbortController;te.set(c,a);const i=t(ee(n,{cause:c,controller:a,isConnected:()=>ct(n,e)}));i instanceof Promise&&i.catch(H);const d=l=>{at(n,l)&&r.delete(d)&&o.has(s)&&(a.abort(B(`${e.__reatom.name} disconnect`)),typeof i=="function"&&i())},r=lt(e,d)},o=it(e,s);return()=>o.delete(s)},ct=(e,{__reatom:t})=>e.get(s=>{const o=t.patch??s(t);return!!o&&o.subs.size+o.listeners.size>0}),ut=y(null,"initializations");ut.__reatom.initState=()=>new WeakMap;const Ie=e=>t=>Object.keys(e).reduce((s,o)=>(s[o]=I(function(n){return s(n,e[o](n.get(s),...[].slice.call(arguments,1)))},`${s.__reatom.name}._${o}`),s),t),dt=(e,t,{shouldPending:s=!0,shouldFulfill:o=!0,shouldReject:n=!0,effect:c=e.__reatom.unstable_fn}={})=>{const a=e.pendingAtom,[i]=t;s&&a(i,r=>++r);const d=i.schedule(()=>new Promise((r,l)=>{he(i.controller),c(...t).then(r,l),i.controller.signal.addEventListener("abort",()=>l(B(i.controller.signal.reason)))}));return fe(oe(i,d,r=>{o&&e.onFulfill(i,r),s&&a(i,l=>--l)},r=>{n&&!$e(r)&&e.onReject(i,r),s&&a(i,l=>--l)}),{controller:i.controller})},_e=e=>t=>{const s=e(t);return xe(t,s)?t:s},Ne={isPending:!1,isFulfilled:!1,isRejected:!1,isSettled:!1,isFirstPending:!1,isEverPending:!1,isEverSettled:!1},mt=()=>e=>{if(!e.statusesAtom){const t=y(new WeakSet,`${e.__reatom.name}.statusesAtom._relatedPromisesAtom`),s=y(Ne,`${e.__reatom.name}.statusesAtom`);s.__reatom.computer=(o,n)=>(o.spy(e,({payload:c})=>{o.get(t).add(c),n=_e(a=>({isPending:o.get(e.pendingAtom)>0,isFulfilled:!1,isRejected:!1,isSettled:!1,isFirstPending:!a.isEverSettled,isEverPending:!0,isEverSettled:a.isEverSettled}))(n)}),n),e.statusesAtom=Object.assign(s,{reset:I(o=>(t(o,new Set),s(o,Ne)))}),e.onCall((o,n)=>{o.get(s),oe(o,n,()=>{o.get(t).has(n)&&s(o,_e(()=>{const c=o.get(e.pendingAtom)>0;return{isPending:c,isFulfilled:!c,isRejected:!1,isSettled:!c,isFirstPending:!1,isEverPending:!0,isEverSettled:!0}}))},()=>{o.get(t).has(n)&&s(o,_e(()=>{const c=o.get(e.pendingAtom)>0;return{isPending:c,isFulfilled:!1,isRejected:!c,isSettled:!c,isFirstPending:!1,isEverPending:!0,isEverSettled:!0}}))})})}return e},we=new WeakSet,pt=(e,t=Y("asyncAtom"))=>{const s=new Re,o=Se(a=>{const i=s.get(a.cause);return O(!i,"reaction manual call"),i},t),n=y((a,i)=>{if(i&&!a.cause.pubs.length)return i;const d=[],r=ee(a,{spy(S,T){O(T,"spy reactions are unsupported in AsyncReaction");const j=a.spy(S);return d.push(j),j}}),l=new AbortController,m=ge(r,S=>l.abort(S));m&&l.signal.addEventListener("abort",m),te.set(r.cause,r.controller=l);const u=e(Oe(r));u.catch(H),s.set(r.cause,u);const C=r.get(o.pendingAtom),b=r.get(o.onFulfill);let E=o(r,...d);E.controller.signal.addEventListener("abort",()=>{c.cacheAtom?.options.ignoreAbort||l.abort(E.controller.signal.reason)});const g=C===r.get(o.pendingAtom),h=r.get(o.onFulfill);return g&&l.abort(B("cached")),g&&b!==h&&(E=Object.assign(Promise.resolve(h[h.length-1].payload),{controller:l})),oe(r,E,()=>we.add(E),()=>we.add(E)).catch(H),i?.controller.abort(B("concurrent")),E},`${t}._promiseAtom`);J(o,a=>a.subscribe(n,H)),J(n,a=>()=>{const i=a.get(n);i.controller.abort(a.controller.signal.reason),we.has(i)||Fe(a,n.__reatom)});const c=Object.assign(a=>a.get((i,d)=>{Fe(a,n.__reatom),d(a,n.__reatom,H);const r=a.get(o),l=r[r.length-1]?.payload;return O(!l,"unexpectedly failed invalidation. Please, report the issue"),l}),o,{promiseAtom:n,init:a=>a.subscribe(n,H)});return Object.defineProperty(o,"_handleCache",{get:()=>c._handleCache}),c},Fe=(e,t)=>e.get((s,o)=>{o(e,t,(n,c)=>{c.pubs=[],c.state=void 0})}),Se=(e,t={})=>{const{name:s=Y("async"),onEffect:o,onFulfill:n,onReject:c,onSettle:a}=typeof t=="string"?{name:t}:t,i=y(0,`${s}.pendingAtom`),d=Object.assign(function(){var u=[].slice.call(arguments);return u[0].get((C,b)=>{const{state:E}=b(u[0],d.__reatom,(g,h)=>{te.set(g.cause,g.controller=new AbortController);const S=ge(u[0],j=>{T?.catch(H),g.controller.abort(j)});S&&g.controller.signal.addEventListener("abort",S),u[0]=Oe(g);var T=d._handleCache?d._handleCache(...u):dt(d,u);oe(g,T,void 0,()=>{l.__reatom.updateHooks.size>1&&T.catch(H)}),h.state=[...h.state,{params:u.slice(1),payload:T}]});return E[E.length-1].payload})},I(e,s)),r=I(`${s}.onFulfill`),l=I(`${s}.onReject`),m=I(`${s}._onSettle`);return r.onCall(u=>m(u)),l.onCall(u=>m(u)),o&&d.onCall((u,C,b)=>o(u,b,C)),n&&r.onCall(n),c&&l.onCall(c),a&&m.onCall(a),J(i,u=>u.subscribe(d,H)),fe(d,{onFulfill:r,onReject:l,onSettle:m,pendingAtom:i})};Se.from=(e,t={})=>(e.name.length>2&&(typeof t=="object"?t.name??=e.name:t??=e.name),Se(function(s){return e(...[].slice.call(arguments,1))},t));const ft=(e,t)=>s=>{if(!s.dataAtom){const o=s.dataAtom=Object.assign(y(e,`${s.__reatom.name}.dataAtom`),{reset:I(n=>{o(n,e)},`${s.__reatom.name}.dataAtom.reset`),mapFulfill:t});o.__reatom.computer=(n,c)=>(n.spy(s.onFulfill,({payload:a})=>{c=t?t(n,a,c):a}),c),s.onFulfill.onCall(n=>{n.get(o)}),J(o,n=>n.subscribe(s,H))}return s},U=(e,t)=>{for(;Q(t);)t=e.spy?e.spy(t):e.get(t);if(typeof t!="object"||t===null)return t;if(Ze(t)){const s={};for(const o in t)s[o]=U(e,t[o]);return s}if(Array.isArray(t)){const s=[];for(const o of t)s.push(U(e,o));return s}if(t instanceof Map){const s=new Map;for(const[o,n]of t)s.set(o,U(e,n));return s}if(t instanceof Set){const s=new Set;for(const o of t)s.add(U(e,o));return s}return t},ht=y(null);ht.__reatom.initState=()=>new WeakMap;const Me=16,V=y(Me,"countAtom").pipe(Ie({increment:e=>e+1,decrement:e=>e-1,reset:()=>Me})),gt=["get","post","put","patch","delete","head","options"];class bt extends Error{response;data;constructor({message:t,response:s,data:o}){super(t),this.name="FetchError",this.response=s,this.data=o}}function _t(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}function wt(...e){const t={};for(const s of e){const o=new Headers(s);for(const[n,c]of o.entries())t[n]=c}return new Headers(t)}class Ee{#t;#e;get;post;put;patch;delete;head;options;constructor(t,s={}){this.#t=t,this.#e=s;for(const o of gt)this[o]=(n,c)=>this.request(n,{...c,method:o})}extends(t,s){const o=this.fetcherParameters(t,s);return new Ee(...o)}async request(t,s){s?.params&&(t=this.pathParams(t,s.params),delete s.params);const o=this.fetcherParameters(t,s);return await St(...o)}fetcherParameters(t,s){const o=_t(this.#t,t),n=wt(this.#e.headers,s?.headers),c={...this.#e,...s,headers:n};return[o,c]}pathParams(t,s){for(const[o,n]of Object.entries(s))t=t.replace(`:${o}`,`${n}`);return t}}async function St(...e){const t=await fetch(...e),s=await t.json();if(!t.ok)throw new bt({message:t.statusText,response:t,data:s});return s}const Et=new Ee("https://jsonplaceholder.typicode.com").extends("posts"),ne=y(1,"todoPageAtom").pipe(Ie({nextTodo:e=>e+1,prevTodo:e=>Math.max(1,e-1)})),ke=pt(e=>{const t=e.spy(ne);return e.schedule(()=>Et.get(`${t}`,e.controller))},"todoResource").pipe(ft(null),mt()),At=y(e=>e.spy(ke.dataAtom)?.title,"todoAtom"),Ct=y(e=>e.spy(ke.statusesAtom).isPending,"todoIsLoadingAtom"),yt=y(e=>e.spy(V)+"px","fontSizeAtom");function vt(){return v("div",null,v("h1",{css:"font-size: var(--size)","css:size":yt},"Demo ",V),v("button",{"on:click":V.increment},"Increment"),v("button",{"on:click":V.decrement},"Decrement"),v("button",{"on:click":V.reset},"Reset"),v("hr",null),v("button",{"on:click":ne.prevTodo},"Prev"),v("button",{"on:click":ne.nextTodo},"Next"),v("h1",null,"Page: ",ne),y(e=>v("span",null,e.spy(Ct)?"Loading...":v("pre",null,At))))}const X=e=>{const t=y(e,`storageAtom#${e.name}`);return Object.assign(s=>o=>{const{key:n,fromSnapshot:c=(g,h)=>h,migration:a,subscribe:i=!!e.subscribe,time:d=Le,toSnapshot:r=(g,h)=>h,version:l=0}=typeof s=="string"?{key:s}:s,m=o.__reatom,{initState:u}=m,C=function(g,h){h===void 0&&(h=null);const S=g.get(t).get(g,n);return S?.id===h?.id?h:S??h},b=function(g,h,S){return h===void 0&&(h=C(g)),h===null||h.version!==l&&a===void 0?u(g):c(g,h.version!==l?a(g,h):h.data,S)};O(!n,"missed key");const E=y(null,`${o.__reatom.name}._${e.name}Atom`);if(E.__reatom.computer=C,i){const{computer:g}=o.__reatom;o.__reatom.computer=(h,S)=>(h.spy(E,T=>{S=b(h,T,S)}),g?g(h,S):S),J(o,h=>h.get(t).subscribe?.(h,n,()=>{E(h,S=>S)}))}else o.__reatom.initState=b;return o.onChange((g,h)=>{const{cause:S}=g,T=g.get(L=>L(Z));g.get(E);let j=g.get((L,N)=>N(g,E.__reatom));if(S.cause===j&&j.cause===S&&(j.cause=T),o.__reatom.patch===S&&S.cause!==j){const{subs:L}=j;j.subs=new Set;const N=E(g,((f,A)=>({data:r(f,A),fromState:!0,id:Te(),timestamp:Date.now(),to:Date.now()+d,version:l}))(g,h));(j=j.proto.patch).subs=j.subs=L,j.cause=T;const _=S.pubs.findIndex(f=>{let{proto:A}=f;return A===j.proto});S.pubs[_]=j,g.get(t).set(g,n,N)}}),o},{storageAtom:t})},ze=e=>{let{name:t,mutable:s=!0,snapshot:o={},subscribe:n=!0}=e;const c=Date.now(),a=c+Le,i=y(Object.entries(o).reduce((r,l)=>{let[m,u]=l;return r[m]={data:u,fromState:!1,id:0,timestamp:c,to:a,version:0},r},{}),`${t}._snapshotAtom`),d=y(function(r,l){return l===void 0&&(l=new Map),l},`${t}._listenersAtom`);return{name:t,get:(r,l)=>r.get(i)[l]??null,set:(r,l,m)=>{if(s){const u=r.get(i),C=u[l];u[l]=m,r.schedule(()=>u[l]=C,-1)}else i(r,u=>({...u,[l]:m}));r.schedule(()=>r.get(d).get(l)?.forEach(u=>u(m)))},subscribe:n?(r,l,m)=>{const u=r.get(d);u.set(l,(u.get(l)??new Set).add(m));const C=()=>{const b=u.get(l);b&&(b.delete(m),b.size===0&&u.delete(l))};return r.schedule(C,-1),C}:void 0,snapshotAtom:i}};function re(e){return new Promise((t,s)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>s(e.error)})}function We(e,t){const s=indexedDB.open(e);s.onupgradeneeded=()=>s.result.createObjectStore(t);const o=re(s);return(n,c)=>o.then(a=>c(a.transaction(t,n).objectStore(t)))}let Ae;function Ce(){return Ae||(Ae=We("keyval-store","keyval")),Ae}function Pt(e,t=Ce()){return t("readonly",s=>re(s.get(e)))}function jt(e,t,s=Ce()){return s("readwrite",o=>(o.put(t,e),re(o.transaction)))}function Tt(e,t=Ce()){return t("readwrite",s=>(s.delete(e),re(s.transaction)))}const $t=e=>{const t=o=>e.postMessage(o),s=y((o,n=new Map)=>n,"withBroadcastChannel._memCacheAtom");return X({name:"withBroadcastChannel",get:(o,n)=>o.get(s).get(n)??null,set(o,n,c){o.get(s).set(n,c),o.schedule(()=>t({key:n,rec:c,_type:"push"}))},clear(o,n){o.get(s).delete(n),o.schedule(()=>t({key:n,rec:null,_type:"push"}))},subscribe(o,n,c){const a=o.get(s),i=d=>{if(d.data?.key===n){if(d.data._type==="pull"){const r=a.get(n);r&&o.schedule(()=>t({_type:"push",key:n,rec:r}))}else if(d.data._type==="push"){const{rec:r}=d.data;r===null?a.delete(n):r.id!==a.get(n)?.id&&(a.set(n,r),c())}}};return e.addEventListener("message",i,!1),a.has(n)||o.schedule(()=>t({_type:"pull",key:n})),()=>e.removeEventListener("message",i,!1)}})};new BroadcastChannel("reatom_withBroadcastChannel_default");const ae={get:Pt,set:jt,del:Tt,createStore:We};new BroadcastChannel("reatom_withIndexedDb_default");const De=(e,t)=>{const s=y((o,n=new Map)=>n,`${e}._memCacheAtom`);return X({name:e,get(o,n){try{const c=o.get(s),a=t.getItem(n);if(a){const i=JSON.parse(a);if(i.to<Date.now())return this.clear(o,n),null;const d=c.get(n);return d?.id===i.id||d?.timestamp>=i.timestamp?d:(c.set(n,i),i)}}catch{return null}return null},set(o,n,c){o.get(s).set(n,c),o.schedule(()=>t.setItem(n,JSON.stringify(c)))},clear(o,n){o.get(s).delete(n),o.schedule(()=>t.removeItem(n))},subscribe(o,n,c){const a=o.get(s),i=d=>{if(d.storageArea===t&&d.key===n)if(d.newValue===null)a.delete(n);else{const r=JSON.parse(d.newValue);r.id!==a.get(n)?.id&&(a.set(n,r),c())}};return globalThis.addEventListener?.("storage",i,!1),()=>globalThis.removeEventListener?.("storage",i,!1)}})};try{var ye=!!globalThis.localStorage}catch{ye=!1}const Lt=ye?De("withLocalStorage",globalThis.localStorage):X(ze({name:"withLocalStorage"}));ye?globalThis.sessionStorage:ze({name:"withSessionStorage"});const ie=y("","inputAtom"),K=y([],"todosAtom").pipe(Lt({key:"todos",toSnapshot:U,fromSnapshot:(e,t)=>t.map(s=>Be(s.title,s.completed))}));K.onChange((e,t)=>console.log("todos",t));function Be(e,t){const s=y(t,`completed#${e}`);return{title:e,completed:s}}const Rt=I((e,t)=>{t.preventDefault();const s=e.get(ie);if(!s){alert("Title is required");return}if(e.get(K).find(n=>n.title===s)){alert("Todo already exists");return}K(e,n=>[...n,Be(s,!1)]),ie(e,"")},"addTodo"),Ht=I(e=>{K(e,[]),ie(e,"")},"clearTodos");function Ot(){return v("div",null,v("h1",null,"Todo List"),v("form",{"on:submit":Rt},v("input",{required:!0,autofocus:!0,"model:value":ie}),v("button",null,"Add"),v("button",{type:"button","on:click":Ht},"Clear")),y(e=>v("ul",null,e.spy(K).map(t=>v("li",null,v("span",null,t.title),v("input",{type:"checkbox","model:checked":t.completed}))))))}function It(){return v(st,null,v(vt,null),v(Ot,null))}nt(document.body,v(It,null))})();
