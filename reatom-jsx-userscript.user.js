// ==UserScript==
// @name        reatom-jsx-userscript
// @version     0.0.0
// @author      crashmax <userscript@crashmax.ru>
// @license     MIT
// @homepage    https://greasify.github.io/reatom-jsx-userscript/
// @match       http://localhost:3000
// @match       https://example.com
// @updateURL   https://greasify.github.io/reatom-jsx-userscript/reatom-jsx-userscript.meta.js
// @downloadURL https://greasify.github.io/reatom-jsx-userscript/reatom-jsx-userscript.user.js
// ==/UserScript==

(function(){"use strict";const pe=Symbol(),ne=function(e){try{return e(...[].slice.call(arguments,1))}catch(t){return setTimeout(()=>{throw t}),t instanceof Error?t:t=new Error(t)}};function L(e,t){if(e)throw new Error(`Reatom error: ${t}`)}const se=e=>e?.__reatom!==void 0,W=e=>e.subs.size+e.listeners.size>0;function re(e){L(typeof e!="function",`invalid "${typeof e}", function expected`)}const ge=e=>e.cause===null?e:ge(e.cause);let G;const $e=({callLateEffect:e=ne,callNearEffect:t=ne}={})=>{let n=new WeakMap,o=p=>n.get(p),r=new Set,a=[],i=[],c=!1,b=null,s=[],l=[],h=[],d=0,C=0,g=!1,E=()=>{for(let p of a)t(p,B);a=[]},w=()=>{if(!g){g=!0,E();for(let p of i)e(p,B),a.length>0&&E();i=[],g=!1}},y=({state:p,proto:f,pubs:_,subs:u,listeners:m},A)=>(f.actual=!1,h.push(f.patch={state:p,proto:f,cause:A,pubs:_,subs:u,listeners:m}),f.patch),S=p=>{for(let f of p.subs.keys()){let _=f.patch??o(f);f.patch&&!f.actual||y(_,p).listeners.size===0&&S(_)}},j=(p,f)=>{if(f.subs.delete(p)&&(l.push(()=>f.subs.add(p)),!W(f))){f.proto.disconnectHooks!==null&&a.push(...f.proto.disconnectHooks);for(let _ of f.pubs)j(f.proto,_)}},F=(p,f)=>{if(!f.subs.has(p)){let _=W(f);if(f.subs.add(p),l.push(()=>f.subs.delete(p)),!_){f.proto.connectHooks!==null&&a.push(...f.proto.connectHooks);for(let u of f.pubs)F(f.proto,u)}}},N=(p,f,_)=>{let{patch:u,actual:m}=f,A=_!==void 0;if(!A&&m&&(u.pubs.length===0||W(u)))return u;let v=u??o(f),Pe=!v,ke=A?p.cause:o(le);if(Pe)v={state:f.initState(p),proto:f,cause:ke,pubs:[],subs:new Set,listeners:new Set};else if(f.computer===null&&!A)return v;u&&!m||(u=y(v,ke));let{state:nt}=u,U={get:p.get,spy:void 0,schedule:p.schedule,subscribe:p.subscribe,cause:u};try{f.computer&&((z,$)=>{let{proto:He,pubs:O}=$,Re=!1;if(O.length===0||O.some(({proto:I,state:k})=>!Object.is(k,($.cause=N(z,I)).state))){let I=[];if(z.spy=({__reatom:k},M)=>{if($.pubs===O){let x=N(z,k),ee=I.push(x)<=O.length?O[I.length-1]:void 0,te=ee?.proto!==x.proto;Re||=te;let oe=k.isAction&&!te?x.state.slice(ee.state.length):x.state;if(!M||!te&&Object.is(oe,ee.state))return oe;if(k.isAction)for(const st of oe)M(st);else M(oe,te?void 0:ee?.state)}else L(!0,"async spy")},$.state=$.proto.computer(z,$.state),$.pubs=I,(Re||O.length>I.length)&&W($)){for(let{proto:k}of O)I.every(M=>M.proto!==k)&&j(He,k.patch??o(k));for(let{proto:k}of I)O.every(M=>M.proto!==k)&&F(He,k.patch??o(k))}}})(U,u),A&&(u.cause=p.cause,_(U,u)),f.actual=!0}catch(z){throw u.error=z}if(!Object.is(nt,u.state)&&(u.subs.size>0&&(A||u.listeners.size>0)&&S(u),f.updateHooks)){let z={get:U.get,spy:void 0,schedule:U.schedule,subscribe:U.subscribe,cause:U.cause};f.updateHooks.forEach($=>s.push(()=>$(z,u)))}return u},B={get(p){if(L(G&&ge(G.cause)!==o(le),"cause collision"),se(p)){let u=p.__reatom;if(c)return N(this,u).state;let m=o(u);return m===void 0||u.computer!==null&&!W(m)?this.get(()=>N(this,u).state):m.state}if(L(b!==null,"tr failed"),c)return p(o,N);c=!0,d=a.length,C=i.length;let f=G===void 0;f&&(G=this);try{var _=p(o,N);for(let u=0;u<h.length;u++){let{listeners:m,proto:A}=h[u];if(m.size>0&&N(this,A),s.length>0)for(let v of s.splice(0))v(this)}if(h.length)for(let u of r)u(h);for(let u of h){let{proto:m,state:A}=u;if(m.isAction&&(u.state=[]),u===m.patch)if(m.patch=null,m.actual=!1,n.set(m,u),m.isAction){if(A.length===0)continue;for(let v of u.listeners)a.push(()=>v(A))}else for(let v of u.listeners)i.push(()=>v(o(m).state))}}catch(u){b=u=u instanceof Error?u:new Error(String(u));for(let m of r)m(h,u);for(let m of l)ne(m,u);for(let{proto:m}of h)m.patch=null,m.actual=!1;throw a.length=d,i.length=C,u}finally{c=!1,b=null,s=[],l=[],h=[],d=0,C=0,f&&(G=void 0)}return w(),_},spy:void 0,schedule(p,f=1){return re(p),L(!this,"missed context"),new Promise((_,u)=>{f===-1?c&&l.push(p):f===0?c&&s.push(()=>p(this)):((f===1?a:i).push(()=>{try{let m=p(this);return m instanceof Promise?m.then(_,u):_(m),m}catch(m){throw u(m),m}}),c||w())})},subscribe(p,f=p){if(re(f),p===f)return r.add(f),()=>r.delete(f);let{__reatom:_}=p,u=pe,m=v=>Object.is(u,v)||f(u=v),A=o(_);return A!==void 0&&W(A)?A.listeners.add(m):this.get(()=>{A=N(this,_,(v,Pe)=>{}),A.listeners.add(m),l.push(()=>_.patch.listeners.delete(m)),_.connectHooks!==null&&a.push(..._.connectHooks);for(let v of A.pubs)F(_,v)}),u===pe&&m((_.patch??o(_)).state),()=>{if(A.listeners.delete(m)&&!W(A)){_.disconnectHooks&&a.push(..._.disconnectHooks);for(let v of A.pubs)j(_,v);c||(l.length=0,w())}}},cause:void 0};return(B.cause=B.get(()=>N(B,le))).cause=null,B};let Le=0,D=e=>`${e}#${++Le}`;function Ne(){return[].slice.call(arguments).reduce((e,t)=>t(e),this)}function Te(e){const t=(n,o)=>e(n,o.state);return(this.__reatom.updateHooks??=new Set).add(t),()=>this.__reatom.updateHooks.delete(t)}function Fe(e){return this.onChange((t,n)=>{const{params:o,payload:r}=n[n.length-1];e(t,r,o)})}function P(e,t=D("_atom")){let n=(r,a)=>r.get((i,c)=>c(r,n.__reatom,(b,s)=>{s.state=typeof a=="function"?a(s.state,b):a}).state),o=null;return typeof e=="function"&&(n={},o=e,e=void 0),n.__reatom={name:t,isAction:!1,patch:null,initState:()=>e,computer:o,connectHooks:null,disconnectHooks:null,updateHooks:null,actual:!1},n.pipe=Ne,n.onChange=Te,be.length===0?n:n.pipe(...be)}const T=(e,t)=>{e!==void 0&&typeof e!="string"||(t=e,e=(o,r)=>r),re(e);let n=P([],t??D("_action"));return n.__reatom.isAction=!0,n.__reatom.unstable_fn=e,Object.assign(function(){var o=[].slice.call(arguments);let r=n(o[0],(a,i)=>(o[0]=i,[...a,{params:o.slice(1),payload:i.cause.proto.unstable_fn(...o)}]));return r[r.length-1].payload},n,{onCall:Fe})},be=[],le=P(void 0,"root").__reatom,H=()=>{},ie=e=>typeof e=="object"&&e!==null,ze=(e,t,n=Object.is)=>{if(Object.is(e,t))return!0;if(!ie(e)||!ie(t)||e.__proto__!==t.__proto__||e instanceof Error)return!1;if(Symbol.iterator in e){let o=e instanceof Map?(i,c)=>n(i[0],c[0])&&n(i[1],c[1]):n,r=e[Symbol.iterator](),a=t[Symbol.iterator]();for(;;){let i=r.next(),c=a.next();if(i.done||c.done||!o(i.value,c.value))return i.done&&c.done}}if(e instanceof Date)return e.getTime()===t.getTime();if(e instanceof RegExp)return String(e)===String(t);for(let o in e)if(o in t==0||!n(e[o],t[o]))return!1;return Object.keys(e).length===Object.keys(t).length},ae=Object.assign,J=function(){return Object.assign({},...[].slice.call(arguments))},Oe=(e=0,t=Number.MAX_SAFE_INTEGER-1)=>Math.floor(Math.random()*(t-e+1))+e,{toString:Ie}=Object.prototype,q=e=>{if(e instanceof Error==0||e.name!=="AbortError"){if(e instanceof Error){var t={cause:e};e=e.message}else e=ie(e)?Ie.call(e):String(e);typeof DOMException>"u"?(e=new Error(e,t)).name="AbortError":e=ae(new DOMException(e,"AbortError"),t)}return e},ce=e=>{if(e?.signal.aborted)throw q(e.signal.reason)},_e=e=>e instanceof Error&&e.name==="AbortError",We=(e,t=globalThis.window)=>{let n,o=new WeakMap,r={},a="",i=(s,l,h)=>{if(l.startsWith("on:"))l=l.slice(3),h=T(h,`${a}.${s.nodeName.toLowerCase()}.${l}`),s.addEventListener(l,d=>h(e,d));else if(l.startsWith("css:"))l="--"+l.slice(4),h==null?s.style.removeProperty(l):s.style.setProperty(l,String(h));else if(l==="css"){n??=t.document.getElementById("reatom-jsx-styles"),n||(n=t.document.createElement("style"),n.id="reatom-jsx-styles",t.document.head.appendChild(n));let d=r[h];d||(d=r[h]="reatom-"+Oe(),n.innerText+="."+d+"{"+h+`}
`),s.classList.add(d)}else if(l==="style"&&typeof h=="object")for(const d in h)h[d]==null?s.style.removeProperty(d):s.style.setProperty(d,h[d]);else l.startsWith("prop:")?s[l.slice(5)]=h:(l.startsWith("attr:")&&(l=l.slice(5)),h==null?s.removeAttribute(l):s.setAttribute(l,String(h)))},c=(s,l)=>{Promise.resolve().then(()=>{if(s.isConnected)for(;s.parentElement&&!o.get(s)?.push(l);)s=s.parentElement;else l()})},b=()=>{};return{h:function(s,l){var h=[].slice.call(arguments,2);if(s===b)return h;if(typeof s=="function"){(l??={}).children=h;let g=s.name;try{return a=s.name,s(l)}finally{a=g}}let d=s.startsWith("svg:")?t.document.createElementNS("http://www.w3.org/2000/svg",s.slice(4)):t.document.createElement(s);for(let g in l){let E=l[g];if(se(E)&&!E.__reatom.isAction){if(g.startsWith("model:")){let y=g=g.slice(6);i(d,"on:input",(S,j)=>{E(S,y==="valueAsNumber"?+j.target.value:j.target[y])}),g==="valueAsNumber"&&(g="value"),g="prop:"+g}let w;w=e.subscribe(E,y=>!w||d.isConnected?g==="$spread"?Object.entries(y).forEach(([S,j])=>i(d,S,j)):i(d,g,y):w()),c(d,w)}else i(d,g,E)}let C=g=>{if(Array.isArray(g))g.forEach(C);else if(se(g)){let E,w=t.document.createTextNode("");E=e.subscribe(g,y=>{if(E&&!w.isConnected)E();else if(L(Array.isArray(y),"array children are not supported"),y instanceof t.HTMLElement){let S=o.get(y);S||o.set(y,S=[]),E&&d.replaceChild(y,w),w=y}else w.textContent=y}),c(d,E),d.appendChild(w)}else d.appendChild(g?.nodeType?g:t.document.createTextNode(String(g)))};return h.forEach(C),d},hf:b,mount:(s,l)=>{s.appendChild(l),new t.MutationObserver(h=>{for(let d of h)for(let C of d.removedNodes){let g=o.get(C);g&&(g.forEach(E=>E()),o.delete(C))}}).observe(s,{childList:!0,subtree:!0})}}},Me=$e(),{h:R,hf:rt,mount:qe}=We(Me);function Be(e,t){try{var n=e()}catch(o){return t(o)}return n&&n.then?n.then(void 0,t):n}class Ee extends WeakMap{has(t){return super.has(t)||t.cause!==null&&this.has(t.cause)}get(t){for(;!super.has(t)&&t.cause;)t=t.cause;return super.get(t)}}const V=new Ee,we=e=>V.get(e)??null,ue=(e,t)=>{const n=we(e.cause);if(n){const o=()=>t(q(n.signal.reason)),r=()=>n.signal.removeEventListener("abort",o);if(!n.signal.aborted)return n.signal.addEventListener("abort",o),e.schedule(()=>n.signal.removeEventListener("abort",o),-1),r;o()}},de=new WeakMap,K=(e,t,n,o)=>{let r=de.get(t);if(!r){const a=t.then(i=>(e.get((c,b)=>r.then.forEach(s=>s(i,c,b))),i),i=>{throw e.get((c,b)=>r.catch.forEach(s=>s(i,c,b))),_e(i)&&a.catch(H),i});de.set(t,r={promise:a,then:[],catch:[]}),de.set(a,r)}return n&&r.then.push(n),o&&r.catch.push(o),r.promise},ye=e=>{const{schedule:t}=e;return J(e,{schedule(n,o){const r=this;if(o===-1)return t.call(this,n,o);let a,i;const c=new Promise((s,l)=>{a=s,i=l}),b=ue(this,s=>{c.catch(H),i(s)});return t.call(this,function(s){try{let l=function(){b?.()};const h=we(r.cause),d=Be(function(){return ce(h),Promise.resolve(n(s)).then(function(C){ce(h),a(C)})},function(C){i(C)});return Promise.resolve(d&&d.then?d.then(l):l())}catch(l){return Promise.reject(l)}},o),c}})},Q=e=>e.cause===null?e:Q(e.cause),Ue=(e,t)=>Q(e.cause)===Q(t.cause),Ge=(e,t)=>(e.__reatom.connectHooks??=new Set).add(t),Xe=(e,t)=>(e.__reatom.disconnectHooks??=new Set).add(t),Y=(e,t)=>{const n=r=>{const a=J(r.get(l=>l(e.__reatom)),{cause:Q(r.cause)}),i=new AbortController;V.set(a,i);const c=t(J(r,{cause:a,controller:i,isConnected:()=>De(r,e)}));c instanceof Promise&&c.catch(H);const b=l=>{Ue(r,l)&&s.delete(b)&&o.has(n)&&(i.abort(q(`${e.__reatom.name} disconnect`)),typeof c=="function"&&c())},s=Xe(e,b)},o=Ge(e,n);return()=>o.delete(n)},De=(e,{__reatom:t})=>e.get(n=>{const o=t.patch??n(t);return!!o&&o.subs.size+o.listeners.size>0}),Je=P(null,"initializations");Je.__reatom.initState=()=>new WeakMap;const Ae=e=>t=>Object.keys(e).reduce((n,o)=>(n[o]=T(function(r){return n(r,e[o](r.get(n),...[].slice.call(arguments,1)))},`${n.__reatom.name}._${o}`),n),t),Ve=(e,t,{shouldPending:n=!0,shouldFulfill:o=!0,shouldReject:r=!0,effect:a=e.__reatom.unstable_fn}={})=>{const i=e.pendingAtom,[c]=t;n&&i(c,s=>++s);const b=c.schedule(()=>new Promise((s,l)=>{ce(c.controller),a(...t).then(s,l),c.controller.signal.addEventListener("abort",()=>l(q(c.controller.signal.reason)))}));return ae(K(c,b,s=>{o&&e.onFulfill(c,s),n&&i(c,l=>--l)},s=>{r&&!_e(s)&&e.onReject(c,s),n&&i(c,l=>--l)}),{controller:c.controller})},fe=e=>t=>{const n=e(t);return ze(t,n)?t:n},Ce={isPending:!1,isFulfilled:!1,isRejected:!1,isSettled:!1,isFirstPending:!1,isEverPending:!1,isEverSettled:!1},Ke=()=>e=>{if(!e.statusesAtom){const t=P(new WeakSet,`${e.__reatom.name}.statusesAtom._relatedPromisesAtom`),n=P(Ce,`${e.__reatom.name}.statusesAtom`);n.__reatom.computer=(o,r)=>(o.spy(e,({payload:a})=>{o.get(t).add(a),r=fe(i=>({isPending:o.get(e.pendingAtom)>0,isFulfilled:!1,isRejected:!1,isSettled:!1,isFirstPending:!i.isEverSettled,isEverPending:!0,isEverSettled:i.isEverSettled}))(r)}),r),e.statusesAtom=Object.assign(n,{reset:T(o=>(t(o,new Set),n(o,Ce)))}),e.onCall((o,r)=>{o.get(n),K(o,r,()=>{o.get(t).has(r)&&n(o,fe(()=>{const a=o.get(e.pendingAtom)>0;return{isPending:a,isFulfilled:!a,isRejected:!1,isSettled:!a,isFirstPending:!1,isEverPending:!0,isEverSettled:!0}}))},()=>{o.get(t).has(r)&&n(o,fe(()=>{const a=o.get(e.pendingAtom)>0;return{isPending:a,isFulfilled:!1,isRejected:!a,isSettled:!a,isFirstPending:!1,isEverPending:!0,isEverSettled:!0}}))})})}return e},he=new WeakSet,Qe=(e,t=D("asyncAtom"))=>{const n=new Ee,o=me(i=>{const c=n.get(i.cause);return L(!c,"reaction manual call"),c},t),r=P((i,c)=>{if(c&&!i.cause.pubs.length)return c;const b=[],s=J(i,{spy(S,j){L(j,"spy reactions are unsupported in AsyncReaction");const F=i.spy(S);return b.push(F),F}}),l=new AbortController,h=ue(s,S=>l.abort(S));h&&l.signal.addEventListener("abort",h),V.set(s.cause,s.controller=l);const d=e(ye(s));d.catch(H),n.set(s.cause,d);const C=s.get(o.pendingAtom),g=s.get(o.onFulfill);let E=o(s,...b);E.controller.signal.addEventListener("abort",()=>{a.cacheAtom?.options.ignoreAbort||l.abort(E.controller.signal.reason)});const w=C===s.get(o.pendingAtom),y=s.get(o.onFulfill);return w&&l.abort(q("cached")),w&&g!==y&&(E=Object.assign(Promise.resolve(y[y.length-1].payload),{controller:l})),K(s,E,()=>he.add(E),()=>he.add(E)).catch(H),c?.controller.abort(q("concurrent")),E},`${t}._promiseAtom`);Y(o,i=>i.subscribe(r,H)),Y(r,i=>()=>{const c=i.get(r);c.controller.abort(i.controller.signal.reason),he.has(c)||ve(i,r.__reatom)});const a=Object.assign(i=>i.get((c,b)=>{ve(i,r.__reatom),b(i,r.__reatom,H);const s=i.get(o),l=s[s.length-1]?.payload;return L(!l,"unexpectedly failed invalidation. Please, report the issue"),l}),o,{promiseAtom:r,init:i=>i.subscribe(r,H)});return Object.defineProperty(o,"_handleCache",{get:()=>a._handleCache}),a},ve=(e,t)=>e.get((n,o)=>{o(e,t,(r,a)=>{a.pubs=[],a.state=void 0})}),me=(e,t={})=>{const{name:n=D("async"),onEffect:o,onFulfill:r,onReject:a,onSettle:i}=typeof t=="string"?{name:t}:t,c=P(0,`${n}.pendingAtom`),b=Object.assign(function(){var d=[].slice.call(arguments);return d[0].get((C,g)=>{const{state:E}=g(d[0],b.__reatom,(w,y)=>{V.set(w.cause,w.controller=new AbortController);const S=ue(d[0],F=>{j?.catch(H),w.controller.abort(F)});S&&w.controller.signal.addEventListener("abort",S),d[0]=ye(w);var j=b._handleCache?b._handleCache(...d):Ve(b,d);K(w,j,void 0,()=>{l.__reatom.updateHooks.size>1&&j.catch(H)}),y.state=[...y.state,{params:d.slice(1),payload:j}]});return E[E.length-1].payload})},T(e,n)),s=T(`${n}.onFulfill`),l=T(`${n}.onReject`),h=T(`${n}._onSettle`);return s.onCall(d=>h(d)),l.onCall(d=>h(d)),o&&b.onCall((d,C,g)=>o(d,g,C)),r&&s.onCall(r),a&&l.onCall(a),i&&h.onCall(i),Y(c,d=>d.subscribe(b,H)),ae(b,{onFulfill:s,onReject:l,onSettle:h,pendingAtom:c})};me.from=(e,t={})=>(e.name.length>2&&(typeof t=="object"?t.name??=e.name:t??=e.name),me(function(n){return e(...[].slice.call(arguments,1))},t));const Ye=(e,t)=>n=>{if(!n.dataAtom){const o=n.dataAtom=Object.assign(P(e,`${n.__reatom.name}.dataAtom`),{reset:T(r=>{o(r,e)},`${n.__reatom.name}.dataAtom.reset`),mapFulfill:t});o.__reatom.computer=(r,a)=>(r.spy(n.onFulfill,({payload:i})=>{a=t?t(r,i,a):i}),a),n.onFulfill.onCall(r=>{r.get(o)}),Y(o,r=>r.subscribe(n,H))}return n},Se=16,X=P(Se,"countAtom").pipe(Ae({increment:e=>e+1,decrement:e=>e-1,reset:()=>Se}));async function Ze(...e){const t=await fetch(...e);if(!t.ok)throw new Error(t.statusText);return await t.json()}const Z=P(1,"todoPageAtom").pipe(Ae({nextTodo:e=>e+1,prevTodo:e=>Math.max(1,e-1)})),je=Qe(async e=>{const t=e.spy(Z);return await e.schedule(()=>Ze(`https://jsonplaceholder.typicode.com/posts/${t}`,e.controller))},"todoResource").pipe(Ye(null),Ke()),xe=P(e=>e.spy(je.dataAtom)?.title,"todoAtom"),et=P(e=>e.spy(je.statusesAtom).isPending,"todoLoadingAtom"),tt=P(e=>e.spy(X)+"px","fontSizeAtom");function ot(){return R("div",null,R("h1",{css:"font-size: var(--size)","css:size":tt},X),R("button",{"on:click":X.increment},"Increment"),R("button",{"on:click":X.decrement},"Decrement"),R("button",{"on:click":X.reset},"Reset"),R("hr",null),R("button",{"on:click":Z.prevTodo},"Prev"),R("button",{"on:click":Z.nextTodo},"Next"),R("h1",null,"Page: ",Z),P(e=>R("span",null,e.spy(et)?"Loading...":R("pre",null,xe))))}qe(document.body,R(ot,null))})();
